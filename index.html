<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SupEHR Sandbox (Phone)</title>
<style>
:root{
  --bg:#0b1220; --card:#111c33; --panel:#0f1a2f; --text:#e6edf7; --muted:#9fb0c5; --border:#223456;
  --radius:14px; --shadow:0 10px 30px rgba(0,0,0,0.25);
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:radial-gradient(1200px 700px at 10% 10%, #122042 0%, var(--bg) 60%) fixed;color:var(--text);font-family:var(--sans)}
.app{width:420px;max-width:420px;height:700px;padding:10px;display:flex;flex-direction:column;gap:10px;min-height:0}
.topbar{display:flex;flex-direction:column;gap:10px;padding:12px;background:rgba(17,28,51,0.65);border:1px solid rgba(34,52,86,0.8);border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(10px)}
.brand{display:flex;gap:10px;align-items:center}
.brand__mark{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(145deg, rgba(102,217,239,0.22), rgba(65,214,161,0.16));border:1px solid rgba(102,217,239,0.35);font-weight:900}
.brand__name{font-weight:900}
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:end}
.control{display:flex;flex-direction:column;gap:6px;font-size:12px;color:var(--muted)}
select{background:rgba(15,26,47,0.8);border:1px solid rgba(34,52,86,0.9);color:var(--text);border-radius:12px;padding:9px 10px;min-width:200px;outline:none}
.btn{background:linear-gradient(145deg, rgba(102,217,239,0.22), rgba(65,214,161,0.16));border:1px solid rgba(102,217,239,0.35);color:var(--text);padding:9px 10px;border-radius:12px;cursor:pointer;font-weight:800}
.btn--ghost{background:rgba(15,26,47,0.6);border:1px solid rgba(34,52,86,0.9)}
.mode{display:flex;gap:6px;padding:6px;background:rgba(15,26,47,0.5);border:1px solid rgba(34,52,86,0.8);border-radius:14px}
.shell{display:grid;grid-template-columns:1fr;gap:10px;min-height:0;flex:1 1 auto;overflow:auto}
.room,.panel{background:rgba(17,28,51,0.65);border:1px solid rgba(34,52,86,0.8);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
.room__stage{position:relative;width:100%;aspect-ratio:3/2;background:rgba(255,255,255,0.03)}
.room__bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.overlayItem{position:absolute;width:56px;height:56px;transform:translate(-50%,-50%)}
.overlayItem img{width:100%;height:100%}
.overlayItem .badge{position:absolute;bottom:-10px;left:50%;transform:translateX(-50%);background:rgba(15,26,47,0.85);border:1px solid rgba(34,52,86,0.9);padding:3px 6px;border-radius:999px;font-size:11px;color:var(--muted);white-space:nowrap}
.attachables{padding:12px;border-top:1px solid rgba(34,52,86,0.7)}
.attachables__title{font-weight:900;margin-bottom:10px}
.attachables__grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
.toggle{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;background:rgba(15,26,47,0.55);border:1px solid rgba(34,52,86,0.85);border-radius:12px}
.toggle__name{font-weight:900;font-size:13px}
.toggle__fhir{font-size:11px;color:var(--muted);font-family:var(--mono)}
.switch{width:44px;height:24px;border-radius:999px;background:rgba(34,52,86,0.85);position:relative;border:1px solid rgba(34,52,86,0.9)}
.switch:after{content:"";width:20px;height:20px;border-radius:999px;background:rgba(230,237,247,0.9);position:absolute;top:1px;left:1px;transition:all .18s ease}
.toggle.is-on .switch{background:rgba(65,214,161,0.22);border-color:rgba(65,214,161,0.35)}
.toggle.is-on .switch:after{left:22px;background:rgba(65,214,161,0.95)}
.tabs{display:flex;gap:6px;padding:10px;border-bottom:1px solid rgba(34,52,86,0.7);background:rgba(15,26,47,0.35);flex-wrap:wrap}
.tab{padding:9px 10px;border-radius:12px;background:rgba(15,26,47,0.6);border:1px solid rgba(34,52,86,0.9);color:var(--muted);cursor:pointer;font-weight:900}
.tab.is-active{color:var(--text);border-color:rgba(102,217,239,0.35);background:rgba(102,217,239,0.12)}
.tabpanes{padding:12px;flex:1;overflow:auto}
.pane{display:none}
.pane.is-active{display:block}
.card{border:1px solid rgba(34,52,86,0.75);background:rgba(15,26,47,0.55);border-radius:14px;padding:12px;margin-bottom:10px}
.card__title{font-weight:950;margin-bottom:8px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.kpi{flex:1 1 160px;padding:10px;border-radius:12px;border:1px solid rgba(34,52,86,0.75);background:rgba(17,28,51,0.55)}
.kpi__label{font-size:12px;color:var(--muted)}
.kpi__value{font-size:20px;font-weight:950;margin-top:2px}
.table{width:100%;border-collapse:collapse;font-size:13px}
.table th,.table td{text-align:left;padding:10px 8px;border-bottom:1px solid rgba(34,52,86,0.65)}
.table th{color:var(--muted);font-size:12px;font-weight:900}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid rgba(34,52,86,0.9);background:rgba(11,18,32,0.55);color:var(--muted);font-size:12px;font-family:var(--mono)}
.footer{padding:8px 10px;color:var(--muted);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
.dialog{width:min(980px,94vw);height:min(720px,80vh);background:rgba(11,18,32,0.98);border:1px solid rgba(34,52,86,0.95);border-radius:16px;color:var(--text);box-shadow:var(--shadow)}
.dialog::backdrop{background:rgba(0,0,0,0.55)}
.dialog__head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid rgba(34,52,86,0.7)}
#jsonOutput{width:calc(100% - 24px);height:calc(100% - 120px);margin:12px;border-radius:12px;background:rgba(15,26,47,0.65);color:var(--text);border:1px solid rgba(34,52,86,0.9);font-family:var(--mono);font-size:12px;padding:12px;outline:none;resize:none}
.dialog__actions{display:flex;justify-content:flex-end;padding:0 12px 12px 12px}
</style>
</head>
<body>
<div class="app">
  <header class="topbar">
    <div class="brand">
      <div class="brand__mark">S</div>
      <div>
        <div class="brand__name">SupEHR Sandbox</div>
        <div style="font-size:12px;color:var(--muted)">420×700 • read-only • fake data</div>
      </div>
    </div>
    <div class="controls">
      <label class="control"><span class="control__label">Patient</span><select id="patientSelect"></select></label>
      <button class="btn" id="simulateBtn">Simulate update</button>
      <button class="btn btn--ghost" id="exportBtn">Export mock Bundle</button>
    </div>
  </header>

  <main class="shell" id="shell">
    <section class="room">
      <div class="room__stage" id="roomStage">
        <img class="room__bg" id="roomBg" alt="Room"/>
      </div>
      <div class="attachables">
        <div class="attachables__title">Attachables</div>
        <div class="attachables__grid" id="attachablesGrid"></div>
      </div>
    </section>

    <section class="panel">
      <div class="tabs">
        <button class="tab is-active" data-tab="vitals">Vitals</button>
        <button class="tab" data-tab="labs">Labs</button>
        <button class="tab" data-tab="imaging">Imaging</button>
        <button class="tab" data-tab="meds">Meds</button>
        <button class="tab" data-tab="notes">Notes</button>
        <button class="tab" data-tab="debug">Debug</button>
      </div>
      <div class="tabpanes">
        <div class="pane is-active" id="pane-vitals"></div>
        <div class="pane" id="pane-labs"></div>
        <div class="pane" id="pane-imaging"></div>
        <div class="pane" id="pane-meds"></div>
        <div class="pane" id="pane-notes"></div>
        <div class="pane" id="pane-debug"></div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div>No PHI • Frontend-only</div>
    <div class="badge">FHIR: simulated</div>
  </footer>
</div>

<dialog id="jsonDialog" class="dialog">
  <div class="dialog__head">
    <div class="dialog__title">Mock FHIR Bundle</div>
    <form method="dialog"><button class="btn btn--ghost">Close</button></form>
  </div>
  <textarea id="jsonOutput" spellcheck="false"></textarea>
  <div class="dialog__actions"><button class="btn" id="copyJsonBtn">Copy</button></div>
</dialog>

<script>
window.SUPEHR_DATA = {
  "patients": [
    {
      "id": "p1",
      "name": "Jane Doe (67F)",
      "mrn": "00012345",
      "location": "Med/Surg \u2022 4W \u2022 412B",
      "dx": [
        "Pneumonia",
        "A-fib"
      ],
      "allergies": [
        "NKDA"
      ],
      "attachables": {
        "oxygen": true,
        "iv": true,
        "piggyback": false,
        "foley": false,
        "chest_tube": false,
        "jp_drain": false,
        "suction": false,
        "feeding": false,
        "telemetry": true,
        "dialysis": false
      },
      "vitals": {
        "HR": 98,
        "BP": "132/76",
        "RR": 20,
        "SpO2": 93,
        "TempF": 100.2
      },
      "labs": [
        {
          "name": "WBC",
          "value": 14.2,
          "unit": "K/uL",
          "flag": "H"
        },
        {
          "name": "Hgb",
          "value": 10.9,
          "unit": "g/dL",
          "flag": "L"
        },
        {
          "name": "Cr",
          "value": 1.3,
          "unit": "mg/dL",
          "flag": ""
        },
        {
          "name": "Lactate",
          "value": 2.1,
          "unit": "mmol/L",
          "flag": "H"
        }
      ],
      "imaging": [
        {
          "when": "Today 08:12",
          "study": "CXR",
          "result": "RLL infiltrate; no effusion."
        }
      ],
      "meds": [
        {
          "name": "Ceftriaxone",
          "sig": "1g IV q24h"
        },
        {
          "name": "Azithromycin",
          "sig": "500mg IV q24h"
        },
        {
          "name": "Metoprolol",
          "sig": "25mg PO BID"
        }
      ],
      "notes": "On 2L NC. Encourage IS. Telemetry for A-fib. Goals: O2 wean, ambulate, discharge in 48\u201372h."
    },
    {
      "id": "p2",
      "name": "John Smith (54M)",
      "mrn": "00067890",
      "location": "ICU \u2022 2N \u2022 208",
      "dx": [
        "Sepsis",
        "AKI"
      ],
      "allergies": [
        "Penicillin (rash)"
      ],
      "attachables": {
        "oxygen": true,
        "iv": true,
        "piggyback": true,
        "foley": true,
        "chest_tube": false,
        "jp_drain": false,
        "suction": true,
        "feeding": true,
        "telemetry": true,
        "dialysis": true
      },
      "vitals": {
        "HR": 112,
        "BP": "96/58",
        "RR": 26,
        "SpO2": 95,
        "TempF": 101.4
      },
      "labs": [
        {
          "name": "WBC",
          "value": 18.9,
          "unit": "K/uL",
          "flag": "H"
        },
        {
          "name": "Cr",
          "value": 3.1,
          "unit": "mg/dL",
          "flag": "H"
        },
        {
          "name": "K",
          "value": 5.6,
          "unit": "mmol/L",
          "flag": "H"
        },
        {
          "name": "Lactate",
          "value": 3.8,
          "unit": "mmol/L",
          "flag": "H"
        }
      ],
      "imaging": [
        {
          "when": "Yesterday 21:05",
          "study": "CT A/P",
          "result": "No source; mild colitis."
        }
      ],
      "meds": [
        {
          "name": "Norepinephrine",
          "sig": "titrate to MAP \u226565"
        },
        {
          "name": "Vancomycin",
          "sig": "per pharmacy"
        },
        {
          "name": "Piperacillin-tazobactam",
          "sig": "held (allergy)"
        }
      ],
      "notes": "On pressor. CRRT started. NG feeds running. Suction PRN. Strict I/O via Foley."
    }
  ],
  "attachablesCatalog": [
    {
      "key": "oxygen",
      "label": "Oxygen",
      "fhir": "Device + Observation",
      "icon": "oxygen.svg",
      "pos": {
        "x": 260,
        "y": 210
      }
    },
    {
      "key": "iv",
      "label": "IV",
      "fhir": "Device",
      "icon": "iv.svg",
      "pos": {
        "x": 640,
        "y": 300
      }
    },
    {
      "key": "piggyback",
      "label": "Piggyback",
      "fhir": "MedicationAdministration",
      "icon": "piggyback.svg",
      "pos": {
        "x": 675,
        "y": 240
      }
    },
    {
      "key": "foley",
      "label": "Foley",
      "fhir": "Device",
      "icon": "foley.svg",
      "pos": {
        "x": 470,
        "y": 460
      }
    },
    {
      "key": "suction",
      "label": "Suction",
      "fhir": "Device",
      "icon": "suction.svg",
      "pos": {
        "x": 130,
        "y": 140
      }
    },
    {
      "key": "feeding",
      "label": "Feeding tube",
      "fhir": "Device + NutritionOrder",
      "icon": "feeding.svg",
      "pos": {
        "x": 390,
        "y": 330
      }
    },
    {
      "key": "telemetry",
      "label": "Telemetry",
      "fhir": "Observation",
      "icon": "telemetry.svg",
      "pos": {
        "x": 780,
        "y": 125
      }
    },
    {
      "key": "dialysis",
      "label": "Dialysis",
      "fhir": "Procedure",
      "icon": "dialysis.svg",
      "pos": {
        "x": 120,
        "y": 470
      }
    }
  ]
};
window.SUPEHR_ASSETS = {
  roomBg: "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5MDAiIGhlaWdodD0iNjAwIiB2aWV3Qm94PSIwIDAgOTAwIDYwMCI+CiAgPGRlZnM+CiAgICA8bGluZWFyR3JhZGllbnQgaWQ9IndhbGwiIHgxPSIwIiB4Mj0iMCIgeTE9IjAiIHkyPSIxIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwIiBzdG9wLWNvbG9yPSIjZjJmNGY3Ii8+CiAgICAgIDxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iI2U2ZTllZiIvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iZmxvb3IiIHgxPSIwIiB4Mj0iMSIgeTE9IjAiIHkyPSIwIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwIiBzdG9wLWNvbG9yPSIjZDZjN2E0Ii8+CiAgICAgIDxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iI2NiYjc5MCIvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICAgIDxmaWx0ZXIgaWQ9InNoYWRvdyIgeD0iLTMwJSIgeT0iLTMwJSIgd2lkdGg9IjE2MCUiIGhlaWdodD0iMTYwJSI+CiAgICAgIDxmZURyb3BTaGFkb3cgZHg9IjAiIGR5PSIzIiBzdGREZXZpYXRpb249IjUiIGZsb29kLWNvbG9yPSIjMDAwIiBmbG9vZC1vcGFjaXR5PSIwLjE4Ii8+CiAgICA8L2ZpbHRlcj4KICA8L2RlZnM+CiAgPHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjkwMCIgaGVpZ2h0PSI0MTAiIGZpbGw9InVybCgjd2FsbCkiLz4KICA8cmVjdCB4PSIwIiB5PSI0MTAiIHdpZHRoPSI5MDAiIGhlaWdodD0iMTkwIiBmaWxsPSJ1cmwoI2Zsb29yKSIvPgogIDxnIGZpbHRlcj0idXJsKCNzaGFkb3cpIj4KICAgIDxyZWN0IHg9IjI0MCIgeT0iMjEwIiB3aWR0aD0iNDIwIiBoZWlnaHQ9IjI1MCIgcng9IjE4IiBmaWxsPSIjZmZmZmZmIiBzdHJva2U9IiNjZmQ2ZTEiIHN0cm9rZS13aWR0aD0iMyIvPgogICAgPHJlY3QgeD0iMjY1IiB5PSIyNDAiIHdpZHRoPSIzNzAiIGhlaWdodD0iMTgwIiByeD0iMTQiIGZpbGw9IiNmNmY3ZmIiIHN0cm9rZT0iI2UyZTdmMCIgc3Ryb2tlLXdpZHRoPSIyIi8+CiAgICA8cmVjdCB4PSIyNzAiIHk9IjIyMCIgd2lkdGg9IjE0MCIgaGVpZ2h0PSI0NSIgcng9IjEwIiBmaWxsPSIjZWVmMmY4IiBzdHJva2U9IiNkN2RlZWEiLz4KICAgIDxyZWN0IHg9IjUyMCIgeT0iMjIwIiB3aWR0aD0iMTIwIiBoZWlnaHQ9IjQ1IiByeD0iMTAiIGZpbGw9IiNlZWYyZjgiIHN0cm9rZT0iI2Q3ZGVlYSIvPgogICAgPHJlY3QgeD0iMjM1IiB5PSIyNTAiIHdpZHRoPSIxNSIgaGVpZ2h0PSIxNjAiIHJ4PSI2IiBmaWxsPSIjZDdkZWVhIi8+CiAgICA8cmVjdCB4PSI2NTAiIHk9IjI1MCIgd2lkdGg9IjE1IiBoZWlnaHQ9IjE2MCIgcng9IjYiIGZpbGw9IiNkN2RlZWEiLz4KICA8L2c+CiAgPGcgb3BhY2l0eT0iMC44NSI+CiAgICA8Y2lyY2xlIGN4PSI0MjAiIGN5PSIzMDAiIHI9IjMwIiBmaWxsPSIjYzlkNGU1Ii8+CiAgICA8cmVjdCB4PSIzOTUiIHk9IjMzMCIgd2lkdGg9IjUwIiBoZWlnaHQ9IjExMCIgcng9IjIwIiBmaWxsPSIjYzlkNGU1Ii8+CiAgICA8cmVjdCB4PSIzNjAiIHk9IjM1MCIgd2lkdGg9IjQwIiBoZWlnaHQ9IjkwIiByeD0iMTgiIGZpbGw9IiNjOWQ0ZTUiLz4KICAgIDxyZWN0IHg9IjQ0MCIgeT0iMzUwIiB3aWR0aD0iNDAiIGhlaWdodD0iOTAiIHJ4PSIxOCIgZmlsbD0iI2M5ZDRlNSIvPgogICAgPHJlY3QgeD0iMzkwIiB5PSI0MzAiIHdpZHRoPSI0MCIgaGVpZ2h0PSI4MCIgcng9IjE4IiBmaWxsPSIjYzlkNGU1Ii8+CiAgICA8cmVjdCB4PSI0MzAiIHk9IjQzMCIgd2lkdGg9IjQwIiBoZWlnaHQ9IjgwIiByeD0iMTgiIGZpbGw9IiNjOWQ0ZTUiLz4KICA8L2c+CiAgPGcgZmlsdGVyPSJ1cmwoI3NoYWRvdykiPgogICAgPHJlY3QgeD0iNjkwIiB5PSI2MCIgd2lkdGg9IjE3MCIgaGVpZ2h0PSIxMjAiIHJ4PSIxMiIgZmlsbD0iIzBkMWIyYSIgb3BhY2l0eT0iMC44NSIvPgogICAgPHJlY3QgeD0iMzUiIHk9IjcwIiB3aWR0aD0iMTcwIiBoZWlnaHQ9Ijk1IiByeD0iMTIiIGZpbGw9IiMwZDFiMmEiIG9wYWNpdHk9IjAuODUiLz4KICA8L2c+CiAgPGcgZmlsdGVyPSJ1cmwoI3NoYWRvdykiPgogICAgPHJlY3QgeD0iNjAiIHk9IjQ0MCIgd2lkdGg9IjE4MCIgaGVpZ2h0PSI3MCIgcng9IjEyIiBmaWxsPSIjZmZmZmZmIiBzdHJva2U9IiNjZmQ2ZTEiLz4KICAgIDxyZWN0IHg9Ijg1IiB5PSI0MjAiIHdpZHRoPSIxMzAiIGhlaWdodD0iMzAiIHJ4PSIxMCIgZmlsbD0iI2ZmZmZmZiIgc3Ryb2tlPSIjY2ZkNmUxIi8+CiAgPC9nPgogIDx0ZXh0IHg9IjIyIiB5PSIyNCIgZm9udC1mYW1pbHk9IkludGVyLCBBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzNiNDQ1MiI+U3VwRUhSIFNhbmRib3ggUm9vbSAocGxhY2Vob2xkZXIgYXJ0KTwvdGV4dD4KPC9zdmc+",
  icons: {"oxygen.svg": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDk2IDk2Ij4KICA8ZGVmcz4KICAgIDxmaWx0ZXIgaWQ9InMiIHg9Ii0zMCUiIHk9Ii0zMCUiIHdpZHRoPSIxNjAlIiBoZWlnaHQ9IjE2MCUiPgogICAgICA8ZmVEcm9wU2hhZG93IGR4PSIwIiBkeT0iMiIgc3RkRGV2aWF0aW9uPSIzIiBmbG9vZC1jb2xvcj0iIzAwMCIgZmxvb2Qtb3BhY2l0eT0iMC4yMiIvPgogICAgPC9maWx0ZXI+CiAgPC9kZWZzPgogIDxnIGZpbHRlcj0idXJsKCNzKSI+CiAgICA8Y2lyY2xlIGN4PSI0OCIgY3k9IjQ4IiByPSIzOCIgZmlsbD0iI2ZmZmZmZiIgc3Ryb2tlPSIjY2ZkNmUxIiBzdHJva2Utd2lkdGg9IjMiLz4KICA8L2c+CiAgPHRleHQgeD0iNDgiIHk9IjU2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIEFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjM0IiBmaWxsPSIjMWYyYTM3Ij5P4oKCPC90ZXh0PgogIDx0ZXh0IHg9IjQ4IiB5PSI4MiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkludGVyLCBBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzRiNTU2MyI+TzI8L3RleHQ+Cjwvc3ZnPg==", "iv.svg": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDk2IDk2Ij4KICA8ZGVmcz4KICAgIDxmaWx0ZXIgaWQ9InMiIHg9Ii0zMCUiIHk9Ii0zMCUiIHdpZHRoPSIxNjAlIiBoZWlnaHQ9IjE2MCUiPgogICAgICA8ZmVEcm9wU2hhZG93IGR4PSIwIiBkeT0iMiIgc3RkRGV2aWF0aW9uPSIzIiBmbG9vZC1jb2xvcj0iIzAwMCIgZmxvb2Qtb3BhY2l0eT0iMC4yMiIvPgogICAgPC9maWx0ZXI+CiAgPC9kZWZzPgogIDxnIGZpbHRlcj0idXJsKCNzKSI+CiAgICA8Y2lyY2xlIGN4PSI0OCIgY3k9IjQ4IiByPSIzOCIgZmlsbD0iI2ZmZmZmZiIgc3Ryb2tlPSIjY2ZkNmUxIiBzdHJva2Utd2lkdGg9IjMiLz4KICA8L2c+CiAgPHRleHQgeD0iNDgiIHk9IjU2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIEFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjM0IiBmaWxsPSIjMWYyYTM3Ij7ihaM8L3RleHQ+CiAgPHRleHQgeD0iNDgiIHk9IjgyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIEFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmaWxsPSIjNGI1NTYzIj5JVjwvdGV4dD4KPC9zdmc+", "piggyback.svg": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDk2IDk2Ij4KICA8ZGVmcz4KICAgIDxmaWx0ZXIgaWQ9InMiIHg9Ii0zMCUiIHk9Ii0zMCUiIHdpZHRoPSIxNjAlIiBoZWlnaHQ9IjE2MCUiPgogICAgICA8ZmVEcm9wU2hhZG93IGR4PSIwIiBkeT0iMiIgc3RkRGV2aWF0aW9uPSIzIiBmbG9vZC1jb2xvcj0iIzAwMCIgZmxvb2Qtb3BhY2l0eT0iMC4yMiIvPgogICAgPC9maWx0ZXI+CiAgPC9kZWZzPgogIDxnIGZpbHRlcj0idXJsKCNzKSI+CiAgICA8Y2lyY2xlIGN4PSI0OCIgY3k9IjQ4IiByPSIzOCIgZmlsbD0iI2ZmZmZmZiIgc3Ryb2tlPSIjY2ZkNmUxIiBzdHJva2Utd2lkdGg9IjMiLz4KICA8L2c+CiAgPHRleHQgeD0iNDgiIHk9IjU2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIEFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjM0IiBmaWxsPSIjMWYyYTM3Ij7inpU8L3RleHQ+CiAgPHRleHQgeD0iNDgiIHk9IjgyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIEFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmaWxsPSIjNGI1NTYzIj5QQjwvdGV4dD4KPC9zdmc+", "foley.svg": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDk2IDk2Ij4KICA8ZGVmcz4KICAgIDxmaWx0ZXIgaWQ9InMiIHg9Ii0zMCUiIHk9Ii0zMCUiIHdpZHRoPSIxNjAlIiBoZWlnaHQ9IjE2MCUiPgogICAgICA8ZmVEcm9wU2hhZG93IGR4PSIwIiBkeT0iMiIgc3RkRGV2aWF0aW9uPSIzIiBmbG9vZC1jb2xvcj0iIzAwMCIgZmxvb2Qtb3BhY2l0eT0iMC4yMiIvPgogICAgPC9maWx0ZXI+CiAgPC9kZWZzPgogIDxnIGZpbHRlcj0idXJsKCNzKSI+CiAgICA8Y2lyY2xlIGN4PSI0OCIgY3k9IjQ4IiByPSIzOCIgZmlsbD0iI2ZmZmZmZiIgc3Ryb2tlPSIjY2ZkNmUxIiBzdHJva2Utd2lkdGg9IjMiLz4KICA8L2c+CiAgPHRleHQgeD0iNDgiIHk9IjU2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIEFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjM0IiBmaWxsPSIjMWYyYTM3Ij7in4I8L3RleHQ+CiAgPHRleHQgeD0iNDgiIHk9IjgyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIEFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmaWxsPSIjNGI1NTYzIj5GPC90ZXh0Pgo8L3N2Zz4=", "chest_tube.svg": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDk2IDk2Ij4KICA8ZGVmcz4KICAgIDxmaWx0ZXIgaWQ9InMiIHg9Ii0zMCUiIHk9Ii0zMCUiIHdpZHRoPSIxNjAlIiBoZWlnaHQ9IjE2MCUiPgogICAgICA8ZmVEcm9wU2hhZG93IGR4PSIwIiBkeT0iMiIgc3RkRGV2aWF0aW9uPSIzIiBmbG9vZC1jb2xvcj0iIzAwMCIgZmxvb2Qtb3BhY2l0eT0iMC4yMiIvPgogICAgPC9maWx0ZXI+CiAgPC9kZWZzPgogIDxnIGZpbHRlcj0idXJsKCNzKSI+CiAgICA8Y2lyY2xlIGN4PSI0OCIgY3k9IjQ4IiByPSIzOCIgZmlsbD0iI2ZmZmZmZiIgc3Ryb2tlPSIjY2ZkNmUxIiBzdHJva2Utd2lkdGg9IjMiLz4KICA8L2c+CiAgPHRleHQgeD0iNDgiIHk9IjU2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIEFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjM0IiBmaWxsPSIjMWYyYTM3Ij7irKQ8L3RleHQ+CiAgPHRleHQgeD0iNDgiIHk9IjgyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIEFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmaWxsPSIjNGI1NTYzIj5DVDwvdGV4dD4KPC9zdmc+", "jp_drain.svg": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDk2IDk2Ij4KICA8ZGVmcz4KICAgIDxmaWx0ZXIgaWQ9InMiIHg9Ii0zMCUiIHk9Ii0zMCUiIHdpZHRoPSIxNjAlIiBoZWlnaHQ9IjE2MCUiPgogICAgICA8ZmVEcm9wU2hhZG93IGR4PSIwIiBkeT0iMiIgc3RkRGV2aWF0aW9uPSIzIiBmbG9vZC1jb2xvcj0iIzAwMCIgZmxvb2Qtb3BhY2l0eT0iMC4yMiIvPgogICAgPC9maWx0ZXI+CiAgPC9kZWZzPgogIDxnIGZpbHRlcj0idXJsKCNzKSI+CiAgICA8Y2lyY2xlIGN4PSI0OCIgY3k9IjQ4IiByPSIzOCIgZmlsbD0iI2ZmZmZmZiIgc3Ryb2tlPSIjY2ZkNmUxIiBzdHJva2Utd2lkdGg9IjMiLz4KICA8L2c+CiAgPHRleHQgeD0iNDgiIHk9IjU2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIEFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjM0IiBmaWxsPSIjMWYyYTM3Ij7ip4k8L3RleHQ+CiAgPHRleHQgeD0iNDgiIHk9IjgyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIEFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmaWxsPSIjNGI1NTYzIj5KUDwvdGV4dD4KPC9zdmc+", "suction.svg": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDk2IDk2Ij4KICA8ZGVmcz4KICAgIDxmaWx0ZXIgaWQ9InMiIHg9Ii0zMCUiIHk9Ii0zMCUiIHdpZHRoPSIxNjAlIiBoZWlnaHQ9IjE2MCUiPgogICAgICA8ZmVEcm9wU2hhZG93IGR4PSIwIiBkeT0iMiIgc3RkRGV2aWF0aW9uPSIzIiBmbG9vZC1jb2xvcj0iIzAwMCIgZmxvb2Qtb3BhY2l0eT0iMC4yMiIvPgogICAgPC9maWx0ZXI+CiAgPC9kZWZzPgogIDxnIGZpbHRlcj0idXJsKCNzKSI+CiAgICA8Y2lyY2xlIGN4PSI0OCIgY3k9IjQ4IiByPSIzOCIgZmlsbD0iI2ZmZmZmZiIgc3Ryb2tlPSIjY2ZkNmUxIiBzdHJva2Utd2lkdGg9IjMiLz4KICA8L2c+CiAgPHRleHQgeD0iNDgiIHk9IjU2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIEFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjM0IiBmaWxsPSIjMWYyYTM3Ij7ijIE8L3RleHQ+CiAgPHRleHQgeD0iNDgiIHk9IjgyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIEFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmaWxsPSIjNGI1NTYzIj5TPC90ZXh0Pgo8L3N2Zz4=", "feeding.svg": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDk2IDk2Ij4KICA8ZGVmcz4KICAgIDxmaWx0ZXIgaWQ9InMiIHg9Ii0zMCUiIHk9Ii0zMCUiIHdpZHRoPSIxNjAlIiBoZWlnaHQ9IjE2MCUiPgogICAgICA8ZmVEcm9wU2hhZG93IGR4PSIwIiBkeT0iMiIgc3RkRGV2aWF0aW9uPSIzIiBmbG9vZC1jb2xvcj0iIzAwMCIgZmxvb2Qtb3BhY2l0eT0iMC4yMiIvPgogICAgPC9maWx0ZXI+CiAgPC9kZWZzPgogIDxnIGZpbHRlcj0idXJsKCNzKSI+CiAgICA8Y2lyY2xlIGN4PSI0OCIgY3k9IjQ4IiByPSIzOCIgZmlsbD0iI2ZmZmZmZiIgc3Ryb2tlPSIjY2ZkNmUxIiBzdHJva2Utd2lkdGg9IjMiLz4KICA8L2c+CiAgPHRleHQgeD0iNDgiIHk9IjU2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIEFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjM0IiBmaWxsPSIjMWYyYTM3Ij7ih6M8L3RleHQ+CiAgPHRleHQgeD0iNDgiIHk9IjgyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIEFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmaWxsPSIjNGI1NTYzIj5ORzwvdGV4dD4KPC9zdmc+", "telemetry.svg": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDk2IDk2Ij4KICA8ZGVmcz4KICAgIDxmaWx0ZXIgaWQ9InMiIHg9Ii0zMCUiIHk9Ii0zMCUiIHdpZHRoPSIxNjAlIiBoZWlnaHQ9IjE2MCUiPgogICAgICA8ZmVEcm9wU2hhZG93IGR4PSIwIiBkeT0iMiIgc3RkRGV2aWF0aW9uPSIzIiBmbG9vZC1jb2xvcj0iIzAwMCIgZmxvb2Qtb3BhY2l0eT0iMC4yMiIvPgogICAgPC9maWx0ZXI+CiAgPC9kZWZzPgogIDxnIGZpbHRlcj0idXJsKCNzKSI+CiAgICA8Y2lyY2xlIGN4PSI0OCIgY3k9IjQ4IiByPSIzOCIgZmlsbD0iI2ZmZmZmZiIgc3Ryb2tlPSIjY2ZkNmUxIiBzdHJva2Utd2lkdGg9IjMiLz4KICA8L2c+CiAgPHRleHQgeD0iNDgiIHk9IjU2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIEFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjM0IiBmaWxsPSIjMWYyYTM3Ij7imaU8L3RleHQ+CiAgPHRleHQgeD0iNDgiIHk9IjgyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIEFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmaWxsPSIjNGI1NTYzIj5URUw8L3RleHQ+Cjwvc3ZnPg==", "dialysis.svg": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDk2IDk2Ij4KICA8ZGVmcz4KICAgIDxmaWx0ZXIgaWQ9InMiIHg9Ii0zMCUiIHk9Ii0zMCUiIHdpZHRoPSIxNjAlIiBoZWlnaHQ9IjE2MCUiPgogICAgICA8ZmVEcm9wU2hhZG93IGR4PSIwIiBkeT0iMiIgc3RkRGV2aWF0aW9uPSIzIiBmbG9vZC1jb2xvcj0iIzAwMCIgZmxvb2Qtb3BhY2l0eT0iMC4yMiIvPgogICAgPC9maWx0ZXI+CiAgPC9kZWZzPgogIDxnIGZpbHRlcj0idXJsKCNzKSI+CiAgICA8Y2lyY2xlIGN4PSI0OCIgY3k9IjQ4IiByPSIzOCIgZmlsbD0iI2ZmZmZmZiIgc3Ryb2tlPSIjY2ZkNmUxIiBzdHJva2Utd2lkdGg9IjMiLz4KICA8L2c+CiAgPHRleHQgeD0iNDgiIHk9IjU2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIEFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjM0IiBmaWxsPSIjMWYyYTM3Ij7iiYs8L3RleHQ+CiAgPHRleHQgeD0iNDgiIHk9IjgyIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iSW50ZXIsIEFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjEyIiBmaWxsPSIjNGI1NTYzIj5IRDwvdGV4dD4KPC9zdmc+"}
};
</script>
<script>
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));

const state = { patientId:null, attachables:{}, vitalsHistory:{} };

function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

function patient(){ return window.SUPEHR_DATA.patients.find(p=>p.id===state.patientId); }

function initPatientSelect(){
  const sel=$("#patientSelect");
  window.SUPEHR_DATA.patients.forEach(p=>{
    const o=document.createElement("option");
    o.value=p.id; o.textContent=`${p.name} • ${p.location}`;
    sel.appendChild(o);
  });
  state.patientId = window.SUPEHR_DATA.patients[0].id;
  sel.value = state.patientId;
  sel.addEventListener("change", ()=>{ state.patientId=sel.value; loadPatient(); });
}

function initAttachablesUI(){
  const grid=$("#attachablesGrid"); grid.innerHTML="";
  window.SUPEHR_DATA.attachablesCatalog.forEach(item=>{
    const el=document.createElement("div");
    el.className="toggle"; el.dataset.key=item.key;
    el.innerHTML=`<div><div class="toggle__name">${item.label}</div><div class="toggle__fhir">${item.fhir}</div></div><div class="switch" role="switch" aria-checked="false"></div>`;
    el.addEventListener("click", ()=>toggleAttachable(item.key));
    grid.appendChild(el);
  });
}

function toggleAttachable(key){
  state.attachables[key]=!state.attachables[key];
  syncAttachablesUI();
  renderRoomOverlay();
  renderDebug();
}

function syncAttachablesUI(){
  $$(".toggle").forEach(el=>{
    const k=el.dataset.key; const on=!!state.attachables[k];
    el.classList.toggle("is-on", on);
    el.querySelector(".switch")?.setAttribute("aria-checked", on?"true":"false");
  });
}

function renderRoomOverlay(){
  const stage=$("#roomStage");
  $$(".overlayItem").forEach(el=>el.remove());
  window.SUPEHR_DATA.attachablesCatalog.forEach(item=>{
    if(!state.attachables[item.key]) return;
    const div=document.createElement("div");
    div.className="overlayItem";
    div.style.left=`${item.pos.x/900*100}%`;
    div.style.top=`${item.pos.y/600*100}%`;
    div.innerHTML=`<img alt="${item.label}"><div class="badge">${item.label}</div>`;
    div.querySelector("img").src = window.SUPEHR_ASSETS.icons[item.icon];
    stage.appendChild(div);
  });
}

function spark(key){
  const arr=state.vitalsHistory[key]||[];
  if(arr.length<2) return "";
  const nums=arr.map(n=>typeof n==="number"?n:parseFloat(n));
  const min=Math.min(...nums), max=Math.max(...nums);
  const chars="▁▂▃▄▅▆▇█";
  const bars=nums.map(n=>{
    const t=(n-min)/(max-min+1e-9);
    const h=Math.round(1+t*7);
    return chars[h-1];
  }).join("");
  return `<div class="badge" title="trend">${bars}</div>`;
}

function kpi(label,value,unit,extra){
  return `<div class="kpi"><div class="kpi__label">${label}</div><div class="kpi__value">${value}${unit?`<span style="font-size:12px;color:var(--muted);font-weight:900;margin-left:6px;">${unit}</span>`:""}</div>${extra?`<div style="margin-top:8px;">${extra}</div>`:""}</div>`;
}

function renderVitals(){
  const p=patient(); if(!p) return;
  ["HR","RR","SpO2","TempF"].forEach(k=>{
    state.vitalsHistory[k]??=[];
    state.vitalsHistory[k].push(p.vitals[k]);
    while(state.vitalsHistory[k].length>14) state.vitalsHistory[k].shift();
  });
  $("#pane-vitals").innerHTML = `
    <div class="card"><div class="card__title">${p.name}</div>
      <div class="row">
        ${kpi("HR",p.vitals.HR,"bpm",spark("HR"))}
        ${kpi("BP",p.vitals.BP,"","")}
        ${kpi("RR",p.vitals.RR,"/min",spark("RR"))}
        ${kpi("SpO2",p.vitals.SpO2,"%",spark("SpO2"))}
        ${kpi("Temp",p.vitals.TempF.toFixed(1),"°F",spark("TempF"))}
      </div>
    </div>
    <div class="card"><div class="card__title">Context</div>
      <div style="line-height:1.55">
        <div><span class="badge">MRN</span> ${p.mrn}</div>
        <div><span class="badge">Location</span> ${p.location}</div>
        <div><span class="badge">Dx</span> ${p.dx.join(", ")}</div>
        <div><span class="badge">Allergies</span> ${p.allergies.join(", ")}</div>
      </div>
    </div>`;
}

function renderLabs(){
  const p=patient();
  $("#pane-labs").innerHTML = `<div class="card"><div class="card__title">Labs</div>
    <table class="table"><thead><tr><th>Test</th><th>Value</th><th>Unit</th><th>Flag</th></tr></thead>
    <tbody>${p.labs.map(l=>`<tr><td>${l.name}</td><td>${l.value}</td><td>${l.unit}</td><td>${l.flag?`<span class="badge">${l.flag}</span>`:""}</td></tr>`).join("")}</tbody></table></div>`;
}

function renderImaging(){
  const p=patient();
  $("#pane-imaging").innerHTML = `<div class="card"><div class="card__title">Imaging</div>
    <table class="table"><thead><tr><th>When</th><th>Study</th><th>Result</th></tr></thead>
    <tbody>${p.imaging.map(i=>`<tr><td>${i.when}</td><td>${i.study}</td><td>${i.result}</td></tr>`).join("")}</tbody></table></div>`;
}

function renderMeds(){
  const p=patient();
  $("#pane-meds").innerHTML = `<div class="card"><div class="card__title">Medications</div>
    <table class="table"><thead><tr><th>Medication</th><th>Sig</th></tr></thead>
    <tbody>${p.meds.map(m=>`<tr><td>${m.name}</td><td>${m.sig}</td></tr>`).join("")}</tbody></table></div>`;
}

function escapeHtml(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

function renderNotes(){
  const p=patient();
  $("#pane-notes").innerHTML = `<div class="card"><div class="card__title">Notes (read-only)</div>
    <div style="white-space:pre-wrap;line-height:1.55">${escapeHtml(p.notes)}</div></div>`;
}

function renderDebug(){
  const onKeys=Object.entries(state.attachables).filter(([k,v])=>v).map(([k])=>k);
  $("#pane-debug").innerHTML = `<div class="card"><div class="card__title">Attachables state</div><div class="badge">${onKeys.length?onKeys.join(", "):"none"}</div></div>`;
}

function renderAll(){
  renderRoomOverlay(); syncAttachablesUI();
  renderVitals(); renderLabs(); renderImaging(); renderMeds(); renderNotes(); renderDebug();
}

function setActiveTab(k){
  $$(".tab").forEach(t=>t.classList.toggle("is-active", t.dataset.tab===k));
  $$(".pane").forEach(p=>p.classList.remove("is-active"));
  $(`#pane-${k}`).classList.add("is-active");
}

function simulateUpdate(){
  const p=patient();
  const d=(x,step,lo,hi)=>clamp(x+(Math.random()*2-1)*step, lo, hi);
  p.vitals.HR=Math.round(d(p.vitals.HR,6,55,150));
  p.vitals.RR=Math.round(d(p.vitals.RR,2,10,38));
  p.vitals.SpO2=Math.round(d(p.vitals.SpO2,2,85,100));
  p.vitals.TempF=Math.round(d(p.vitals.TempF,0.25,96.0,103.5)*10)/10;
  renderAll();
}

function exportBundle(){
  const p=patient(); const now=new Date().toISOString();
  const bundle={resourceType:"Bundle",type:"collection",timestamp:now,entry:[]};
  bundle.entry.push({resource:{resourceType:"Patient",id:p.id,identifier:[{system:"urn:demo:mrn",value:p.mrn}],name:[{text:p.name}]}});

  Object.entries(p.vitals).forEach(([k,v])=>{
    bundle.entry.push({resource:{resourceType:"Observation",status:"final",code:{text:k},subject:{reference:`Patient/${p.id}`},effectiveDateTime:now,valueString:String(v)}});
  });
  p.labs.forEach(l=>{
    bundle.entry.push({resource:{resourceType:"Observation",status:"final",code:{text:l.name},subject:{reference:`Patient/${p.id}`},effectiveDateTime:now,valueQuantity:{value:l.value,unit:l.unit},interpretation:l.flag?[{text:l.flag}]:undefined}});
  });
  p.meds.forEach((m,idx)=>{
    bundle.entry.push({resource:{resourceType:"MedicationAdministration",status:"completed",id:`medadmin-${idx+1}`,medicationCodeableConcept:{text:m.name},subject:{reference:`Patient/${p.id}`},effectiveDateTime:now,note:[{text:m.sig}]}})
  });
  return bundle;
}

function initTabs(){ $$(".tab").forEach(b=>b.addEventListener("click",()=>setActiveTab(b.dataset.tab))); }

function initDialog(){
  const dlg=$("#jsonDialog"), ta=$("#jsonOutput"), copy=$("#copyJsonBtn");
  $("#exportBtn").addEventListener("click",()=>{ ta.value=JSON.stringify(exportBundle(),null,2); dlg.showModal(); });
  copy.addEventListener("click", async ()=>{
    try{ await navigator.clipboard.writeText(ta.value); copy.textContent="Copied"; setTimeout(()=>copy.textContent="Copy",900); }
    catch{ copy.textContent="Copy failed"; setTimeout(()=>copy.textContent="Copy",1200); }
  });
}

function loadPatient(){
  const p=patient(); state.attachables={...p.attachables}; state.vitalsHistory={};
  initAttachablesUI(); syncAttachablesUI(); renderAll();
}

document.addEventListener("DOMContentLoaded", ()=>{
  $("#roomBg").src = window.SUPEHR_ASSETS.roomBg;
  initPatientSelect(); initTabs(); initDialog();
  $("#simulateBtn").addEventListener("click", simulateUpdate);
  loadPatient();
});
</script>
</body>
</html>